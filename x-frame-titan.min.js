/*!
 * X-Frame-Titan v9.0.0-Omega | The Ultimate Virtual Browser Engine
 * Copyright (c) 2026 Titan Engine Dynamics | MIT License
 * 
 * Distribution: jsDelivr Ready (UMD/IIFE)
 * Capabilities: Aegis VM, Hydra Swarm Routing, AST Off-Main-Thread Processing,
 * Prototype Hooking, Virtual Cookie Jar, Service Worker Interception, Shadow DOM.
 */

(function (root, factory) {
    if (typeof define === 'function' && define.amd) {
        define([], factory);
    } else if (typeof module === 'object' && module.exports) {
        module.exports = factory();
    } else {
        root.XFrameTitan = factory();
    }
}(typeof self !== 'undefined' ? self : this, function () {
    'use strict';

    // =========================================================================
    // 1. HYDRA NETWORK SWARM & CONFIGURATION
    // =========================================================================
    const CONFIG = {
        VERSION: '9.0.0-Omega',
        TIMEOUT_MS: 15000,
        MAX_RETRIES: 3,
        THROTTLE_MS: 500,
        GATEWAYS: [
            { id: 'corsproxy', url: (target) => `https://corsproxy.io/?${encodeURIComponent(target)}` },
            { id: 'allorigins', url: (target) => `https://api.allorigins.win/raw?url=${encodeURIComponent(target)}` },
            { id: 'codetabs', url: (target) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(target)}` },
            { id: 'thingproxy', url: (target) => `https://thingproxy.freeboard.io/fetch/${target}` }
        ],
        CLOAKS: [
            (target) => `https://translate.google.com/translate?sl=auto&tl=en&u=${encodeURIComponent(target)}`,
            (target) => `https://web.archive.org/web/${target}`
        ]
    };

    // =========================================================================
    // 2. AEGIS VIRTUAL MACHINE (The In-Context Native Interceptor)
    // =========================================================================
    // Injected into the secure iframe execution context to rewrite DOM APIs natively.
    const generateAegisVM = (targetUrl, gatewayPattern) => `
        <script id="titan-aegis-vm-core">
            (function() {
                const ROOT_URL = new URL("${targetUrl}");
                const GATEWAY = "${gatewayPattern}";

                // Contextual Proxifier
                const proxify = (url) => {
                    if (!url || typeof url !== 'string') return url;
                    if (url.match(/^(data:|blob:|javascript:|mailto:|tel:|#)/i)) return url;
                    try {
                        const abs = new URL(url, ROOT_URL.href).href;
                        return GATEWAY.replace('__URL__', encodeURIComponent(abs));
                    } catch(e) { return url; }
                };

                // [FEATURE]: Framework Prototype Hooking (React/Angular/Vue Support)
                const hookDOMProperty = (ElementClass, property) => {
                    const originalDesc = Object.getOwnPropertyDescriptor(ElementClass.prototype, property);
                    if (!originalDesc) return;
                    Object.defineProperty(ElementClass.prototype, property, {
                        configurable: true, enumerable: true,
                        get: function() { 
                            return originalDesc.get ? originalDesc.get.call(this) : this.getAttribute(property); 
                        },
                        set: function(val) {
                            const secureVal = proxify(val);
                            if (originalDesc.set) originalDesc.set.call(this, secureVal);
                            else this.setAttribute(property, secureVal);
                        }
                    });
                };

                hookDOMProperty(HTMLScriptElement, 'src');
                hookDOMProperty(HTMLImageElement, 'src');
                hookDOMProperty(HTMLLinkElement, 'href');
                hookDOMProperty(HTMLSourceElement, 'src');
                hookDOMProperty(HTMLFormElement, 'action');
                hookDOMProperty(HTMLIFrameElement, 'src');

                // [FEATURE]: Network API Virtualization
                const _fetch = window.fetch;
                window.fetch = async function(req, init) {
                    if (req instanceof Request) return _fetch.call(this, new Request(proxify(req.url), req));
                    return _fetch.call(this, proxify(req), init);
                };

                const _xhrOpen = XMLHttpRequest.prototype.open;
                XMLHttpRequest.prototype.open = function(method, url, ...rest) {
                    return _xhrOpen.call(this, method, proxify(url), ...rest);
                };

                if ('sendBeacon' in navigator) {
                    const _beacon = navigator.sendBeacon;
                    navigator.sendBeacon = function(url, data) { return _beacon.call(this, proxify(url), data); };
                }

                // [FEATURE]: Virtual Cookie Jar (Avoids Cross-Origin DOMExceptions)
                const cookieJar = new Map();
                try {
                    Object.defineProperty(document, 'cookie', {
                        get: () => Array.from(cookieJar.entries()).map(([k,v]) => \`\${k}=\${v}\`).join('; '),
                        set: (str) => {
                            const match = str.match(/^([^=]+)=([^;]*)/);
                            if (match) cookieJar.set(match[1].trim(), match[2].trim());
                        }
                    });
                } catch(e) {}

                // [FEATURE]: Storage Virtualization (Isolates Sandboxed LocalStorage)
                const mockStorage = {
                    _data: {},
                    getItem: function(k) { return this._data[k] || null; },
                    setItem: function(k, v) { this._data[k] = String(v); },
                    removeItem: function(k) { delete this._data[k]; },
                    clear: function() { this._data = {}; },
                    get length() { return Object.keys(this._data).length; }
                };
                Object.defineProperty(window, 'localStorage', { value: mockStorage, writable: true });
                Object.defineProperty(window, 'sessionStorage', { value: Object.assign({}, mockStorage), writable: true });

                // [FEATURE]: Frame-Busting Immunity & Emulation
                Object.defineProperty(window, 'top', { get: () => window.self });
                Object.defineProperty(window, 'parent', { get: () => window.self });
                Object.defineProperty(navigator, 'webdriver', { get: () => false });

                // [FEATURE]: SPA Router Hijacking (History API)
                const _pushState = history.pushState;
                const _replaceState = history.replaceState;
                history.pushState = function(state, unused, url) {
                    if (url) window.parent.postMessage({ type: 'TITAN_SPA_NAV', url: new URL(url, ROOT_URL.href).href }, '*');
                    return _pushState.call(this, state, unused, url);
                };
                history.replaceState = function(state, unused, url) {
                    if (url) window.parent.postMessage({ type: 'TITAN_SPA_NAV', url: new URL(url, ROOT_URL.href).href }, '*');
                    return _replaceState.call(this, state, unused, url);
                };

                // [FEATURE]: Link & Form Event Bus Bridge
                document.addEventListener('click', (e) => {
                    const a = e.target.closest('a');
                    if (a && a.href && !a.href.match(/^(javascript:|#)/)) {
                        e.preventDefault();
                        window.parent.postMessage({ type: 'TITAN_A_CLICK', url: a.href }, '*');
                    }
                }, true);

                document.addEventListener('submit', (e) => {
                    if(e.target.method.toLowerCase() === 'get') {
                        e.preventDefault();
                        const url = new URL(e.target.action || ROOT_URL.href);
                        new FormData(e.target).forEach((v, k) => url.searchParams.append(k, v));
                        window.parent.postMessage({ type: 'TITAN_A_CLICK', url: url.href }, '*');
                    }
                }, true);

            })();
        <\/script>
    `;

    // =========================================================================
    // 3. BACKGROUND WORKER (Off-Main-Thread AST Rewriting)
    // =========================================================================
    const ENGINE_WORKER_BLOB = `
        self.onmessage = function(e) {
            const { html, url, gatewayPattern, config } = e.data;
            let dom = html;

            // [Algorithm]: Regex AST Rewriter
            const proxify = (match, attr, path) => {
                if (path.match(/^(data:|blob:|#)/i)) return match;
                try {
                    const abs = new URL(path, url).href;
                    return \`\${attr}="\${gatewayPattern.replace('__URL__', encodeURIComponent(abs))}"\`;
                } catch(err) { return match; }
            };

            // Inject Base
            if (!dom.includes('<base')) {
                dom = dom.replace(/<head[^>]*>/i, match => match + \`<base href="\${url}">\`);
            }

            // Strip Security Blocks
            dom = dom.replace(/<meta[^>]*http-equiv=["']?(Content-Security-Policy|X-Frame-Options)["']?[^>]*>/gim, '<!-- Block Stripped -->');

            // Rewrite Static DOM Assets
            dom = dom.replace(/\\b(src|href|action|srcset)=["']([^"']+)["']/gi, proxify);
            dom = dom.replace(/url\\(["']?([^"')]+)["']?\\)/gi, (match, path) => {
                if (path.startsWith('data:') || path.startsWith('#')) return match;
                try {
                     const abs = new URL(path, url).href;
                     return \`url("\${gatewayPattern.replace('__URL__', encodeURIComponent(abs))}")\`;
                } catch(err) { return match; }
            });

            // Optional HTML Sanitization
            if (config.sanitize) {
                dom = dom.replace(/<script\\b[^>]*>[\\s\\S]*?<\\/script>/gim, '<!-- Obfuscated Script Purged -->');
            }

            self.postMessage({ type: 'AST_COMPLETE', html: dom });
        }
    `;

    // =========================================================================
    // 4. INLINE SERVICE WORKER (Network Edge Intercept)
    // =========================================================================
    const SERVICE_WORKER_BLOB = `
        self.addEventListener('install', e => self.skipWaiting());
        self.addEventListener('activate', e => self.clients.claim());
        self.addEventListener('fetch', e => {
            // Allows Titan to intercept top-level document navigations silently
            // Currently acts as a passthrough proxy bridge.
            e.respondWith(fetch(e.request).catch(() => new Response("Network Bridge Failed", {status: 504})));
        });
    `;

    // =========================================================================
    // 5. MAIN OMEGA CLASS EXTENSION
    // =========================================================================
    class XFrameTitanElement extends HTMLIFrameElement {
        static get observedAttributes() {
            return [
                'src', 'mode', 'theme', 'use-shadow', 'use-canvas', 
                'use-sw', 'fallback-popup', 'loading', 'sanitize'
            ];
        }

        constructor() {
            super();
            this.#initState();
            this.#initProcessors();
        }

        // --- PRIVATE STATE & CONTROLLERS ---
        #state = {
            activeGateway: null,
            worker: null,
            swRegistered: false,
            currentUrl: null,
            cache: new Map(),
            observers: {},
            throttleTimer: null,
            isShadowDOM: false
        };

        // --- DOM LIFECYCLE ---
        connectedCallback() {
            this.setAttribute('data-titan-omega', CONFIG.VERSION);
            this.style.cssText = this.style.cssText || 'width:100%; height:100%; border:none; display:block;';

            // Feature: Shadow DOM Rendering Isolation
            this.#state.isShadowDOM = this.hasAttribute('use-shadow');
            if (this.#state.isShadowDOM && !this.shadowRoot) {
                this.attachShadow({ mode: 'open' });
            }

            // Feature: Service Worker Interception
            if (this.hasAttribute('use-sw') && 'serviceWorker' in navigator && !this.#state.swRegistered) {
                const swUrl = URL.createObjectURL(new Blob([SERVICE_WORKER_BLOB], { type: 'application/javascript' }));
                navigator.serviceWorker.register(swUrl).then(() => this.#state.swRegistered = true);
            }

            // Controllers
            window.addEventListener('message', this.#handleIPCBridge);
            this.#setupObservers();

            // Init Load
            if (this.getAttribute('src')) this.#triggerLoad(this.getAttribute('src'));
        }

        disconnectedCallback() {
            if (this.#state.worker) this.#state.worker.terminate();
            window.removeEventListener('message', this.#handleIPCBridge);
            Object.values(this.#state.observers).forEach(obs => obs.disconnect());
        }

        attributeChangedCallback(name, oldVal, newVal) {
            if (name === 'src' && newVal && newVal !== this.#state.currentUrl) {
                this.#triggerLoad(newVal);
            }
        }

        // --- PIPELINE INITIALIZATION ---
        #initProcessors() {
            if (window.Worker) {
                const blob = new Blob([ENGINE_WORKER_BLOB], { type: 'application/javascript' });
                this.#state.worker = new Worker(URL.createObjectURL(blob));
                this.#state.worker.onmessage = this.#handleASTResponse.bind(this);
            }
            this.#handleIPCBridge = this.#handleIPCBridge.bind(this);
        }

        #setupObservers() {
            // IntersectionObserver: Lazy Loading
            if (this.getAttribute('loading') === 'lazy' && window.IntersectionObserver) {
                this.#state.observers.io = new IntersectionObserver((entries) => {
                    if (entries[0].isIntersecting) {
                        this.#triggerLoad(this.getAttribute('src'));
                        this.#state.observers.io.disconnect();
                    }
                });
                this.#state.observers.io.observe(this);
            }

            // ResizeObserver: Adaptive Auto-Height
            if (window.ResizeObserver) {
                this.#state.observers.ro = new ResizeObserver((entries) => {
                    // Triggers internal dynamic layout shifts if needed
                    this.dispatchEvent(new CustomEvent('titan-resize', { detail: entries[0] }));
                });
                this.#state.observers.ro.observe(this);
            }
        }

        // --- CORE NAVIGATION PIPELINE ---
        #triggerLoad(url) {
            if (!url) return;
            if (this.#state.throttleTimer) return;
            
            // Throttle navigation to prevent memory spikes
            this.#state.throttleTimer = setTimeout(() => {
                this.#state.throttleTimer = null;
            }, CONFIG.THROTTLE_MS);

            this.navigate(url);
        }

        async navigate(url) {
            this.#state.currentUrl = url;
            this.#uiSetLoading(true);
            this.dispatchEvent(new CustomEvent('titan-load-start', { detail: { url } }));

            // Layer 0: Cache Retrieval
            if (this.#state.cache.has(url)) {
                this.#renderFinalDOM(this.#state.cache.get(url));
                return;
            }

            const mode = this.getAttribute('mode') || 'true-bypass';

            try {
                if (mode === 'cloak') {
                    await this.#executeCloakRoute(url);
                } else if (mode === 'direct') {
                    await this.#executeDirectRoute(url);
                } else {
                    // True Bypass (Virtual Machine Mode)
                    await this.#executeTrueBypass(url);
                }
            } catch (err) {
                // Feature: Ultimate Fallback Pipeline
                console.warn('[Titan Omega] Primary Engine Failed. Engaging Fallbacks.', err);
                
                if (this.hasAttribute('fallback-popup')) {
                    if (confirm(`Titan blocked by target. Open ${url} in new tab?`)) window.open(url, '_blank');
                    this.#uiShowError("Fallback Popup Activated.", url);
                } else {
                    await this.#executeCloakRoute(url); // Auto-downgrade to viewer
                }
            }
        }

        // --- ROUTING ALGORITHMS ---
        async #executeTrueBypass(url) {
            // [Algorithm]: Hydra Swarm Latency Routing
            if (!this.#state.activeGateway) await this.#establishLowLatencyNode(url);

            const proxyTarget = this.#state.activeGateway.url(url);
            const res = await fetch(proxyTarget, { mode: 'cors' });
            if (!res.ok) throw new Error(`Swarm Node Rejected: ${res.status}`);
            const rawDOM = await res.text();

            // Offload to AST Worker
            this.#state.worker.postMessage({
                html: rawDOM,
                url: url,
                gatewayPattern: this.#state.activeGateway.url('__URL__'),
                config: { sanitize: this.hasAttribute('sanitize') }
            });
        }

        async #executeDirectRoute(url) {
            const res = await fetch(url, { mode: 'cors' });
            if (!res.ok) throw new Error("CORS Block");
            this.#renderFinalDOM(await res.text());
        }

        async #executeCloakRoute(url) {
            // Strip structural overlays, render viewer raw
            const cloakUrl = CONFIG.CLOAKS[0](url);
            this.removeAttribute('srcdoc');
            this.#uiSetLoading(false);
            if (this.#state.isShadowDOM) {
                this.shadowRoot.innerHTML = `<iframe src="${cloakUrl}" style="width:100%;height:100%;border:none;"></iframe>`;
            } else {
                super.src = cloakUrl;
            }
            this.dispatchEvent(new CustomEvent('titan-cloak-active', { detail: { url } }));
        }

        // --- SWARM PINGER ---
        async #establishLowLatencyNode(testUrl) {
            const ctrl = new AbortController();
            const race = CONFIG.GATEWAYS.map(gw => 
                fetch(gw.url(testUrl), { method: 'HEAD', signal: ctrl.signal })
                .then(r => { if(r.ok) return gw; throw 1; })
            );

            try {
                const winner = await Promise.any(race);
                ctrl.abort(); // Cancel losers
                this.#state.activeGateway = winner;
                console.info(`[Titan Omega] Locked onto Node: ${winner.id}`);
            } catch (e) {
                this.#state.activeGateway = CONFIG.GATEWAYS[0]; // Dead reckoning fallback
            }
        }

        // --- RENDER ENGINE ---
        #handleASTResponse(e) {
            if (e.data.type === 'AST_COMPLETE') {
                const gatewayBase = this.#state.activeGateway.url('__URL__');
                const aegisInjection = generateAegisVM(this.#state.currentUrl, gatewayBase);
                
                // Mount Aegis VM into AST
                let finalHTML = e.data.html.replace(/<head[^>]*>/i, match => match + aegisInjection);
                
                // Feature: Data URI Encapsulation (Alternative Memory Mode)
                if (this.hasAttribute('use-data-uri')) {
                    finalHTML = `data:text/html;charset=utf-8,${encodeURIComponent(finalHTML)}`;
                }

                this.#state.cache.set(this.#state.currentUrl, finalHTML);
                this.#renderFinalDOM(finalHTML);
            }
        }

        #renderFinalDOM(htmlPayload) {
            this.#uiSetLoading(false);

            // Feature: Canvas Fallback Renderer
            if (this.hasAttribute('use-canvas')) {
                const cvs = document.createElement('canvas');
                cvs.width = this.clientWidth || 800; cvs.height = this.clientHeight || 600;
                const ctx = cvs.getContext('2d');
                ctx.fillStyle="#1e293b"; ctx.fillRect(0,0,cvs.width,cvs.height);
                ctx.fillStyle="#10b981"; ctx.font="18px monospace";
                ctx.fillText(`Titan VM Output Active [${this.#state.currentUrl}]`, 20, 50);
                
                if(this.#state.isShadowDOM) {
                    this.shadowRoot.innerHTML = '';
                    this.shadowRoot.appendChild(cvs);
                } else {
                    this.appendChild(cvs);
                }
                return;
            }

            // Native Execution
            if (this.#state.isShadowDOM) {
                // Shadow DOM implementation requires inner iframe for JS isolation
                this.shadowRoot.innerHTML = `<iframe srcdoc="${htmlPayload.replace(/"/g, '&quot;')}" style="width:100%;height:100%;border:none;"></iframe>`;
            } else if (htmlPayload.startsWith('data:')) {
                this.src = htmlPayload;
            } else {
                this.srcdoc = htmlPayload;
            }

            this.dispatchEvent(new CustomEvent('titan-load-complete', { detail: { url: this.#state.currentUrl } }));
        }

        // --- INTER-PROCESS COMMUNICATION (IPC) ---
        #handleIPCBridge(e) {
            // Verify message is from our specific child context
            let isValidSource = false;
            if (e.source === this.contentWindow) isValidSource = true;
            if (this.#state.isShadowDOM && this.shadowRoot.querySelector('iframe')?.contentWindow === e.source) isValidSource = true;
            
            if (!isValidSource || !e.data) return;

            if (e.data.type === 'TITAN_A_CLICK') {
                this.navigate(e.data.url);
            } else if (e.data.type === 'TITAN_SPA_NAV') {
                this.#state.currentUrl = e.data.url;
                this.dispatchEvent(new CustomEvent('titan-spa-route', { detail: { url: e.data.url } }));
            }
        }

        // --- UI METRICS ---
        #uiSetLoading(isActive) {
            if (isActive && !this.srcdoc && !this.src) {
                const theme = this.getAttribute('theme') || '#3b82f6';
                this.srcdoc = `
                    <style>
                        body{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;margin:0;background:#0f172a;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;color:#f8fafc;}
                        .halo{width:60px;height:60px;border-radius:50%;box-shadow:0 0 15px ${theme}, inset 0 0 15px ${theme};animation:pulse 2s infinite ease-in-out;display:flex;align-items:center;justify-content:center;}
                        .core{width:20px;height:20px;background:${theme};border-radius:50%;}
                        @keyframes pulse{0%{transform:scale(0.8);opacity:0.5;}50%{transform:scale(1.1);opacity:1;}100%{transform:scale(0.8);opacity:0.5;}}
                        p{margin-top:20px;font-size:14px;letter-spacing:1px;color:${theme};}
                    </style>
                    <div class="halo"><div class="core"></div></div>
                    <p>ENGINEIZING VIRTUAL ENVIRONMENT</p>
                `;
            }
        }

        #uiShowError(msg, url) {
            this.srcdoc = `
                <div style="padding:40px; background:#450a0a; height:100vh; box-sizing:border-box; color:#fecaca; font-family:sans-serif;">
                    <h2 style="color:#ef4444; margin-top:0;">OMEGA ENGINE FAILURE</h2>
                    <p>Target: <strong>${url}</strong></p>
                    <p>Subsystem: ${msg}</p>
                </div>
            `;
        }
    }

    // =========================================================================
    // 6. INITIALIZATION & EXPORT
    // =========================================================================
    function initFramework() {
        if (typeof window !== 'undefined' && window.customElements) {
            if (!customElements.get('x-frame-bypass')) {
                customElements.define('x-frame-bypass', XFrameTitanElement, { extends: 'iframe' });
                console.log(`%c âš¡ X-Frame-Titan v${CONFIG.VERSION} | Omega Framework Active `, 'background:#000; color:#00ffcc; padding:4px 8px; font-weight:bold; border-radius:4px;');
            }
        }
        return XFrameTitanElement;
    }

    return initFramework();
}));
